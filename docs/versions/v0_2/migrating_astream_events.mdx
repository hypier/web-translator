---
sidebar_position: 2
sidebar_label: astream_events v2
---

# 迁移到 Astream Events v2

我们在 `0.2.x` 版本中新增了 `astream_events` API 的 `v2` 版本。您可以查看这个 [PR](https://github.com/langchain-ai/langchain/pull/21638) 以获取更多细节。

`v2` 版本是对 `v1` 版本的重写，应该更高效，事件的输出也更一致。API 的 `v1` 版本将被弃用，取而代之的是 `v2` 版本，并将在 `0.4.0` 中移除。

以下是 API 的 `v1` 和 `v2` 版本之间的变化列表。

### `on_chat_model_end` 的输出

在 `v1` 中，与 `on_chat_model_end` 相关的输出取决于聊天模型是作为根级可运行项运行还是作为链的一部分运行。

作为根级可运行项，输出为：

```python
"data": {"output": AIMessageChunk(content="hello world!", id='some id')}
```

作为链的一部分，输出为：

```
            "data": {
                "output": {
                    "generations": [
                        [
                            {
                                "generation_info": None,
                                "message": AIMessageChunk(
                                    content="hello world!", id=AnyStr()
                                ),
                                "text": "hello world!",
                                "type": "ChatGenerationChunk",
                            }
                        ]
                    ],
                    "llm_output": None,
                }
            },
```

在 `v2` 中，输出将始终是更简单的表示：

```python
"data": {"output": AIMessageChunk(content="hello world!", id='some id')}
```

:::note
非聊天模型（即常规 LLM）目前将始终与更详细的格式相关联。
:::

### `on_retriever_end` 的输出

`on_retriever_end` 的输出将始终返回一个 `Documents` 列表。

之前：
```python
{
    "data": {
        "output": [
            Document(...),
            Document(...),
            ...
        ]
    }
}
```

### 移除了 `on_retriever_stream`

`on_retriever_stream` 事件是实现的遗留产物，现已被移除。

与该事件相关的完整信息已在 `on_retriever_end` 事件中提供。

请改用 `on_retriever_end`。

### 移除 `on_tool_stream`

`on_tool_stream` 事件是实现中的一个遗留物，现已被移除。

与该事件相关的完整信息已在 `on_tool_end` 事件中提供。

请改用 `on_tool_end`。

### 名称传播

可运行对象的名称已更新，以保持更一致性。

```python
model = GenericFakeChatModel(messages=infinite_cycle).configurable_fields(
    messages=ConfigurableField(
        id="messages",
        name="Messages",
        description="Messages return by the LLM",
    )
)
```

在 `v1` 中，事件名称为 `RunnableConfigurableFields`。

在 `v2` 中，事件名称为 `GenericFakeChatModel`。

如果您正在按事件名称过滤，请检查是否需要更新您的过滤器。

### RunnableRetry

在LCEL链中使用[RunnableRetry](https://api.python.langchain.com/en/latest/runnables/langchain_core.runnables.retry.RunnableRetry.html)进行流式处理时，生成了一个不正确的`on_chain_end`事件，在`v1`中对应于正在重试的失败可运行调用。此事件在`v2`中已被移除。

对此更改不需要采取任何行动。